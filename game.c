#include "game.h"

#include <stdio.h>
#include <stdlib.h>

#include "gba.h"
/* TODO: */
// Include any header files for title screen or exit
// screen images generated by nin10kit. Example for the provided garbage
// image:
#include "images/garbage.h"
#include "images/Title.h"
#include "images/Map.h"
#include "images/Battle-Grass.h"
#include "images/Rules-Background.h"
#include "images/Character-Select.h"
#include "images/Arrow.h"
#include "images/FemaleSprite.h"
#include "images/FemaleSprite2.h"
#include "images/FemaleSprite3.h"
#include "images/Boss1.h"
#include "images/Boss2.h"
#include "images/Boss3.h"
#include "images/Enemy1.h"
#include "images/Enemy2.h"
#include "images/Enemy3.h"
#include "images/Anim1.h"
#include "images/Anim2.h"
#include "images/FemaleFight.h"
#include "images/Pirate.h"
/* TODO: */
// Add any additional states you need for your app.
typedef enum
{
  START,
  DRAWRULES,
  RULES,
  DRAWSELECT,
  SELECT,
  DRAWMAP,
  MAP,
  ANIM,
  FIGHT,
  WAIT,
  WIN,
  LOSE,
} GBAState;

void changeSprite(Character *a);
void changeSpriteBoss(Boss *a);
int checkBounds(int row, int col);
void startBattle(Character *a, Character * b, GBAState *statePtr);

int main(void)
{

  Character player;

  player.health = 3;
  player.row = 9;
  player.col = 1;
  player.male = 0;
  player.female = 0;
  player.counter = 0;
  player.sprite = player.sprite1;

  Character enemy1;
  enemy1.health = 1;
  enemy1.row = 2;
  enemy1.col = 2;
  enemy1.sprite = enemy1.sprite1;

  ArrowSelect gender;
  gender.row = 126;
  gender.col = 16;

  ArrowSelect rps;
  rps.row = 126;
  rps.col = 16;

  Boss boss;
  boss.row = 16;
  boss.col = 160;
  boss.health=1;
  boss.sprite = boss.sprite1;
  for (int i = 0; i < 1054; i++)
  {
    boss.sprite1[i] = Boss1[i];
    boss.sprite2[i] = Boss2[i];
    boss.sprite3[i] = Boss3[i];
  }

  /* TODO: */
  // Manipulate REG_DISPCNT here to set Mode 3. //
  REG_DISPCNT = MODE3 | BG2_ENABLE;
  // Save current and previous state of button input.
  u32 previousButtons = BUTTONS;
  u32 currentButtons = BUTTONS;

  // Load initial game state
  GBAState state = START;

  while (1)
  {

   

    currentButtons = BUTTONS; // Load the current state of the buttons

    /* TODO: */
    // Manipulate the state machine below as needed //
    // NOTE: Call waitForVBlank() before you draw
    waitForVBlank();
    switch (state)
    {

    case START:
      drawFullScreenImageDMA(Title);

      if (KEY_DOWN(BUTTON_START, currentButtons))
      {
        state = DRAWRULES;
        // fillScreenDMA(BLACK);
      }

      // state = ?
      break;

    case DRAWRULES:
      drawFullScreenImageDMA(RulesBackground);
      drawString(40, 5, "Hello My name is Armaan Lala", WHITE);
      drawString(50, 5, "Welcome to my GBA game", WHITE);
      drawString(60, 5, "This game is based off of Fire Embelem", WHITE);
      drawString(70, 5, "Use the D-pad to move on the screen", WHITE);
      drawString(80, 5, "Run into an enemy to fight them", WHITE);
      drawString(90, 5, "During a fight, pick Rock, Paper,", WHITE);
      drawString(100, 5, "or Scissors", WHITE);
      drawString(110, 5, "You must defeat all enemies to win", WHITE);
      drawString(120, 5, "You have three lives, Good Luck!", WHITE);
      drawCenteredString(70, 0, 240, 160, "Press Start to continue", BLACK);

      state = RULES;
      break;

    case RULES:
      if (KEY_DOWN(BUTTON_START, currentButtons) && !KEY_DOWN(BUTTON_START, previousButtons))
      {
        state = DRAWSELECT;
        // fillScreenDMA(BLACK);
      }
      if (KEY_DOWN(BUTTON_SELECT, currentButtons))
      {
        state = START;
        // fillScreenDMA(BLACK);
      }
      break;

    case DRAWSELECT:

      drawFullScreenImageDMA(CharacterSelect);
      // drawCenteredString(50,0,240,160,"Would you like to play as a Boy or a Girl",WHITE);
      drawCenteredString(30, 0, 240, 160, "Which gender would you like to play as?", WHITE);
      drawCenteredString(50, 80, 240, 160, "Boy", WHITE);
      drawCenteredString(50, -80, 240, 160, "Girl", WHITE);
      state = SELECT;

      break;

    case SELECT:
      if (KEY_DOWN(BUTTON_SELECT, currentButtons))
      {
        state = START;
        // fillScreenDMA(BLACK);
      }
      drawImageDMA(gender.row, gender.col, ARROW_WIDTH, ARROW_HEIGHT, Arrow);
      if (KEY_DOWN(BUTTON_RIGHT, currentButtons) && !KEY_DOWN(BUTTON_RIGHT, previousButtons))
      {
        gender.col = 180;
        drawRectDMA(gender.row, 16, 7, 7, BLACK);
      }
      if (KEY_DOWN(BUTTON_LEFT, currentButtons) && !KEY_DOWN(BUTTON_LEFT, previousButtons))
      {
        gender.col = 16;
        drawRectDMA(gender.row, 180, 7, 7, BLACK);
      }

      if (KEY_DOWN(BUTTON_A, currentButtons) && !KEY_DOWN(BUTTON_A, previousButtons))
      {
        if (gender.col == 16)
        {
          player.female = 1;
          for (int i = 0; i < 256; i++)
          {
            player.sprite1[i] = FemaleSprite[i];
            player.sprite2[i] = FemaleSprite2[i];
            player.sprite3[i] = FemaleSprite3[i];

            enemy1.sprite1[i] = Enemy1[i];
            enemy1.sprite2[i] = Enemy2[i];
            enemy1.sprite3[i] = Enemy3[i];
          }
        }
        else if (gender.col == 180)
        {
          player.male = 1;
        }
        state = DRAWMAP;
        // fillScreenDMA(BLACK);
      }

      break;

    case DRAWMAP:
      drawFullScreenImageDMA(Map);
      // fillScreenDMA(BLACK);
      state = MAP;
      break;

    case MAP:

      startBattle(&player, &enemy1, &state);

      if (vBlankCounter % 30 == 0)
      {
        changeSprite(&player);
        changeSprite(&enemy1);
        changeSpriteBoss(&boss);
      }

      // Have to draw boss first to avoid weird tearing.
      if (enemy1.health == 1)
      {

        drawImageDMA(enemy1.row * 16, enemy1.col * 16, 16, 16, enemy1.sprite);
      }
      if (boss.health == 1)
      {
        drawImageDMA(boss.row, boss.col, BOSS1_WIDTH, BOSS1_HEIGHT, boss.sprite);
      }
      drawImageDMA(player.row * 16, player.col * 16, 16, 16, player.sprite);

      if (KEY_DOWN(BUTTON_DOWN, currentButtons) && !KEY_DOWN(BUTTON_DOWN, previousButtons) && player.row < 9 && checkBounds(player.row + 1, player.col) == 1)
      {
        drawBackgroundImageDMA(player.row * 16, player.col * 16, 16, 16, Map);
        player.row += 1;
      }
      if (KEY_DOWN(BUTTON_UP, currentButtons) && !KEY_DOWN(BUTTON_UP, previousButtons) && player.row >= 1 && checkBounds(player.row - 1, player.col) == 1)
      {
        drawBackgroundImageDMA(player.row * 16, player.col * 16, 16, 16, Map);
        player.row -= 1;
      }
      if (KEY_DOWN(BUTTON_RIGHT, currentButtons) && !KEY_DOWN(BUTTON_RIGHT, previousButtons) && player.col < 14 && checkBounds(player.row, player.col + 1) == 1)
      {
        drawBackgroundImageDMA(player.row * 16, player.col * 16, 16, 16, Map);
        player.col += 1;
      }
      if (KEY_DOWN(BUTTON_LEFT, currentButtons) && !KEY_DOWN(BUTTON_LEFT, previousButtons) && player.col >= 1 && checkBounds(player.row, player.col - 1) == 1)
      {
        drawBackgroundImageDMA(player.row * 16, player.col * 16, 16, 16, Map);
        player.col -= 1;
      }

      break;

    case ANIM:

      fillScreenDMA(BLACK);

      for (int i = 0; i < 120; i += 2)
      {
        waitForVBlank();
        for (int j = 0; j < 240; j += 2)
        {
          drawBackgroundImageDMA(i, j, 2, 1, BattleGrass);
        }
      }
      for (int i = 1; i < 120; i += 2)
      {
        waitForVBlank();
        for (int j = 1; j < 240; j += 2)
        {
          drawBackgroundImageDMA(i, j, 2, 1, BattleGrass);
        }
      }
      // for (int i = 1; i < 160; i+=2){
      //   for (int j = 0; j < 240; j ++){

      //   drawBackgroundImageDMA(i,j,1,1,BattleGrass);

      //   }
      //   // drawBackgroundImageDMA(0,240-i,1,160,BattleGrass);
      // }
      state = FIGHT;

     

      break;

    case FIGHT:

    
      // Have to draw boss first to avoid weird tearing.
      // drawImageDMA(boss.row, boss.col, BOSS1_WIDTH, BOSS1_HEIGHT, boss.sprite);
      if (player.row == 2 && player.col == 2)
      {
        drawImageDMA(32, 176, 64, 64, Pirate);
      }

      drawImageDMA(48, 16, 64, 64, FemaleFight);

      drawCenteredString(50, 0, 240, 160, "Lance", WHITE);
      drawCenteredString(50, 80, 240, 160, "Sword", WHITE);
      drawCenteredString(50, -80, 240, 160, "Axe", WHITE);
      drawImageDMA(rps.row,rps.col,ARROW_WIDTH,ARROW_HEIGHT,Arrow);

      if (KEY_DOWN(BUTTON_RIGHT, currentButtons) && !KEY_DOWN(BUTTON_RIGHT, previousButtons) && rps.col == 90)
      {
        rps.col = 170;
        drawRectDMA(rps.row, 90, 7, 7, BLACK);
      }

       else if (KEY_DOWN(BUTTON_RIGHT, currentButtons) && !KEY_DOWN(BUTTON_RIGHT, previousButtons) && rps.col == 16)
      {
        rps.col = 90;
        drawRectDMA(rps.row, 16, 7, 7, BLACK);
      }

      else if (KEY_DOWN(BUTTON_LEFT, currentButtons) && !KEY_DOWN(BUTTON_LEFT, previousButtons) && rps.col == 90 )
      {
        rps.col = 16;
        drawRectDMA(rps.row, 90, 7, 7, BLACK);
      }
      else if (KEY_DOWN(BUTTON_LEFT, currentButtons) && !KEY_DOWN(BUTTON_LEFT, previousButtons) && rps.col == 170 )
      {
        rps.col = 90;
        drawRectDMA(rps.row, 170, 7, 7, BLACK);
      }
     

    if (KEY_DOWN(BUTTON_A, currentButtons) && !KEY_DOWN(BUTTON_A, previousButtons)){

      int enemy = randint(1,3);

      if (rps.col == 90){


        if (enemy == 2){
          //tie
          drawCenteredString(60,0,240,160,"The enemy picked lance",WHITE);
          drawCenteredString(70,0,240,160,"Its a tie",WHITE);
          // player.health --;
          player.row++;
          state = WAIT;
        }
        else if (enemy == 3) {
          drawCenteredString(60,0,240,160,"The enemy picked sword",WHITE);
          drawCenteredString(70,0,240,160,"You won this fight",WHITE);
          if (player.row ==2 && player.col ==2){
            enemy1.health--;
            // player.health --;
          // player.row++;
          state = WAIT;
          }
        }
        else if (enemy == 1) {
          drawCenteredString(60,0,240,160,"The enemy picked axe",WHITE);
          drawCenteredString(70,0,240,160,"You lost this fight",WHITE);

          player.health --;
          player.row++;
          state = WAIT;
        }
        

      } else if (rps.col == 170){

        if (enemy == 2){
          //tie
          drawCenteredString(60,0,240,160,"The enemy picked lance",WHITE);
          drawCenteredString(70,0,240,160,"You lost this fight",WHITE);
          player.health --;
          player.row++;
          state = WAIT;
          
        }
        else if (enemy == 3) {
          drawCenteredString(60,0,240,160,"The enemy picked sword",WHITE);
          drawCenteredString(70,0,240,160,"Its a tie",WHITE);
          // player.health --;
          player.row++;
          state = WAIT;
          
        }
        else if (enemy == 1) {
          drawCenteredString(60,0,240,160,"The enemy picked axe",WHITE);
          drawCenteredString(70,0,240,160,"You won this fight",WHITE);
          if (player.row ==2 && player.col ==2){
            enemy1.health--;
            // player.health --;
          // player.row++;
          state = WAIT;
          }
        }

      } else if (rps.col == 16){

        if (enemy == 2){
          //tie
          drawCenteredString(60,0,240,160,"The enemy picked lance",WHITE);
          drawCenteredString(70,0,240,160,"You won this fight",WHITE);
          if (player.row ==2 && player.col ==2){
            enemy1.health--;
            // player.health --;
          // player.row++;
          state = WAIT;
          }
        }
        else if (enemy == 3) {
          drawCenteredString(60,0,240,160,"The enemy picked sword",WHITE);
          drawCenteredString(70,0,240,160,"You lost this fight",WHITE);
          player.health --;
          player.row++;
          state = WAIT;
        }
        else if (enemy == 1) {
          drawCenteredString(60,0,240,160,"The enemy picked axe",WHITE);
          drawCenteredString(70,0,240,160,"Its a tie",WHITE);
          // player.health --;
          player.row++;
          state = WAIT;
          
        }

      }


    }


















      

      // state = ?
      break;

    case WAIT:
      if (KEY_JUST_PRESSED(BUTTON_A,currentButtons,previousButtons)){
        state = DRAWMAP;
      }
    break;







    case WIN:

      // state = ?
      break;

    case LOSE:

      // state = ?
      break;
    }

    previousButtons = currentButtons; // Store the current state of the buttons
  }
  UNUSED(player);

  UNUSED(previousButtons); // You can remove this once previousButtons is used

  return 0;
}

// TODO: Remove Unused Code

//       fillScreenDMA(BLACK);
//       drawImageDMA(player.row,player.col, LYN_WIDTH,LYN_HEIGHT,Lyn);
//       if (KEY_DOWN(BUTTON_UP, currentButtons) && !KEY_DOWN(BUTTON_UP, previousButtons))
//       {
//         player.row -= 10;
//       }
//       if (KEY_DOWN(BUTTON_DOWN, currentButtons) && !KEY_DOWN(BUTTON_DOWN, previousButtons))
//       {
//         player.row += 10;
//       }
//       if (KEY_DOWN(BUTTON_LEFT, currentButtons) && !KEY_DOWN(BUTTON_LEFT, previousButtons))
//       {
//         player.col -= 10;
//       }
//       if (KEY_DOWN(BUTTON_RIGHT, currentButtons) && !KEY_DOWN(BUTTON_RIGHT, previousButtons))
//       {
//         player.col += 10;
//       }

//       if (KEY_DOWN(BUTTON_B, currentButtons) && !KEY_DOWN(BUTTON_B, previousButtons))
//       {
//         drawCenteredString(HEIGHT / 2, WIDTH / 2, 0, 10, str1, WHITE);
//       }
//       if (KEY_DOWN(BUTTON_A, currentButtons) && !KEY_DOWN(BUTTON_A, previousButtons))
//       {
//         fillScreenDMA(BLACK);
//         player.health = player.health - 1;
//       }

void changeSprite(Character *a)
{
  a->counter++;
  if ((a->counter) % 3 == 0)
  {
    a->sprite = a->sprite1;
  }
  else if ((a->counter) % 3 == 1)
  {
    a->sprite = a->sprite2;
  }
  else if ((a->counter) % 3 == 2)
  {
    a->sprite = a->sprite3;
  }
}

void changeSpriteBoss(Boss *a)
{
  a->counter++;
  if ((a->counter) % 3 == 0)
  {
    a->sprite = a->sprite1;
  }
  else if ((a->counter) % 3 == 1)
  {
    a->sprite = a->sprite2;
  }
  else if ((a->counter) % 3 == 2)
  {
    a->sprite = a->sprite3;
  }
}

int checkBounds(int row, int col)
{
  if (row == 9 && col == 4)
  {
    return 0;
  }
  else if (row == 8 && col == 4)
  {
    return 0;
  }
  else if (row == 7 && col == 4)
  {
    return 0;
  }
  else if (row == 7 && col == 5)
  {
    return 0;
  }
  else if (row == 6 && col == 5)
  {
    return 0;
  }
  else if (row == 5 && col == 5)
  {
    return 0;
  }
  else if (row == 0 && col == 8)
  {
    return 0;
  }
  else if (row == 1 && col == 8)
  {
    return 0;
  }
  else if (row == 2 && col == 8)
  {
    return 0;
  }
  else if (row == 3 && col == 8)
  {
    return 0;
  }
  else if (row == 4 && col == 8)
  {
    return 0;
  }
  else if (row == 5 && col == 8)
  {
    return 0;
  }
  else if (row == 6 && col == 8)
  {
    return 0;
  }
  else if (row == 7 && col == 8)
  {
    return 0;
  }
  else if (row == 0 && col == 14)
  {
    return 0;
  }
  else if (row == 1 && col == 14)
  {
    return 0;
  }
  else if (row == 2 && col == 14)
  {
    return 0;
  }
  else if (row == 3 && col == 14)
  {
    return 0;
  }
  else if (row == 4 && col == 14)
  {
    return 0;
  }
  else if (row == 5 && col == 14)
  {
    return 0;
  }
  else if (row == 6 && col == 14)
  {
    return 0;
  }
  else if (row == 7 && col == 14)
  {
    return 0;
  }
  else if (row == 7 && col == 13)
  {
    return 0;
  }
  else if (row == 7 && col == 12)
  {
    return 0;
  }
  else if (row == 7 && col == 10)
  {
    return 0;
  }
  else if (row == 7 && col == 9)
  {
    return 0;
  }
  else if (row == 6 && col == 13)
  {
    return 0;
  }
  else if (row == 6 && col == 12)
  {
    return 0;
  }
  else if (row == 6 && col == 10)
  {
    return 0;
  }
  else if (row == 6 && col == 9)
  {
    return 0;
  }
  else if (row == 0 && col == 13)
  {
    return 0;
  }
  else if (row == 0 && col == 12)
  {
    return 0;
  }
  else if (row == 0 && col == 10)
  {
    return 0;
  }
  else if (row == 0 && col == 9)
  {
    return 0;
  }
  else if (row == 3 && col == 10)
  {
    return 0;
  }
  else if (row == 3 && col == 12)
  {
    return 0;
  }

  return 1;
}

void startBattle(Character *a, Character * b, GBAState *state)
{

  if (a->row == 2 && a->col == 2 && b->health ==1 )
  {
    *state = ANIM;
  }
}